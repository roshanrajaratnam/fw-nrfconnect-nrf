.. _lib_azure_iot_hub:

Azure IoT Hub
#############

.. contents::
   :local:
   :depth: 2

The Azure IoT Hub library provides an API to connect to an `Azure IoT Hub`_ instance and interact with it.
It connects to Azure IoT Hub using MQTT over TLS.

Optionally, the library supports `Azure IoT Hub Device Provisioning Service (DPS)`_.
DPS can be enabled at compile time to make use of the device provisioning services for onboarding of devices to Azure IoT Hub.
When the device provisioning is complete, the library automatically connects to the assigned Azure IoT Hub.

The library also has integrated support for a proprietary FOTA solution.
For more information on Azure FOTA, see the documentation on :ref:`lib_azure_fota` library and :ref:`azure_fota_sample` sample.

The library uses :ref:`Azure SDK for Embedded C` for message processing and other operations.

.. important::
   If the server sends a device-bound message when the device is unavailable for a period of time, for instance while in LTE Power Saving Mode, the server will most likely terminate the TCP connection.
   This will result in additional data traffic as the device has to reconnect to the server, which in turn requires a new TLS handshake and MQTT connection establishment.


.. _prereq_connect_to_azure_iot_hub:

Prerequisites for connecting to Azure IoT Hub
*********************************************

In order to connect to Azure IoT Hub, an Azure account and an Azure IoT Hub instance must first be created and configured.
See `Creating an Azure IoT Hub instance using the Azure portal`_ for more information.

.. note::
   If you do not use DPS to provision devices to your IoT Hub, make sure that you select ``X.509 CA Signed`` as the *Authentication type* while `Registering the device with Azure IoT Hub`_.

The connection to Azure IoT Hub with MQTT is secured using TLS.
For testing purposes, see `Creating Azure IoT Hub certificates`_ for the steps to create certificates and a private key for the leaf device, and to register the generated test root certificate to be used with an IoT hub.

The Azure IoT Hub library requires the provisioning of the following certificates and private key for a successful TLS connection:

1. `Baltimore CyberTrust Root Certificate`_ - Server certificate, used to verify the server's certificate while connecting.
#. Public device certificate - generated by the procedures described in `Creating Azure IoT Hub certificates`_ , used by Azure IoT Hub to authenticate the device.
#. Private key of the device.

.. important::
   Azure has started the process of migrating their IoT Hub and DPS server certificates from `Baltimore CyberTrust Root Certificate`_ to `DigiCert Global Root G2`_.
   Azure advises that all devices should have both Baltimore CyberTrust Root and DigiCert Global Root G2 certificates going forward to avoid disruption of service when the transition happens.
   Refer to `Azure IoT TLS: Critical changes`_ for updated information and timeline.

.. note::
   The location and name of the generated public device certificate and private key files vary depending on the method you use for the credential generation.
   For PowerShell scripts, the device certificate is called :file:`mydevice-public.pem` and the private key is :file:`mydevice-private.pem`.
   These files are located in the working directory with the other generated files.

   For bash scripts, the public device certificate is called :file:`new-device.cert.pem` and is located in a directory called :file:`certs` within the :file:`script` directory.
   The private key is called :file:`new-device.key.pem` and located in a directory called :file:`private` within the :file:`script` directory.

   The file and directory names may change if Azure changes their scripts.


.. _azure_iot_hub_flash_certs:

Provisioning of the certificates
================================

To provision the certificates and the private key to the nRF9160 modem, complete the following steps:

1. `Download nRF Connect for Desktop`_.
#. Update the modem firmware on the onboard modem of the nRF9160-based device to the latest version by following the steps in :ref:`nrf9160_gs_updating_fw_modem`.
#. Build and program the :ref:`at_client_sample` sample to the nRF9160-based device as explained in :ref:`gs_programming`.
#. Launch the `LTE Link Monitor`_ application, which is part of `nRF Connect for Desktop`_.
#. Click :guilabel:`Certificate manager` located at the top right corner.
#. Copy the server root certificate into the ``CA certificate`` entry.
#. Copy and paste the device certificate and the key created using the scripts located in `Creating Azure IoT Hub certificates`_, into the respective entries (``Client certificate``, ``Private key``).
#. Select a desired security tag (any positive integer in the range 0 to 2147483647) and click :guilabel:`Update certificates`.

.. note::
   The chosen security tag while provisioning the certificates must be same as the security tag configured by the :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` option.

.. note::
   If more than one root server certificate is used, the second one can be provisioned to a different security tag and configured in the application using :kconfig:option:`CONFIG_AZURE_IOT_HUB_SECONDARY_SEC_TAG`.
   Then the modem will check both security tags if necessary when verifying the server's certificate.


Configuring the library
=======================

You can configure the library to connect to Azure IoT Hub with or without using DPS.

Configuration without using DPS
+++++++++++++++++++++++++++++++

To connect to Azure IoT Hub without using DPS, complete the following minimum required configuration:

1. In the `Azure Portal`_, navigate to :guilabel:`IoT Hub` and select the desired IoT hub.
#. In the overview page, locate and copy the ``Hostname`` and configure :kconfig:option:`CONFIG_AZURE_IOT_HUB_HOSTNAME` to this address.
   The hostname can also be set at run time.
#. Set the option :kconfig:option:`CONFIG_AZURE_IOT_HUB_DEVICE_ID` to the device ID.
   The device ID must match the device ID used while creating the certificates.
   The device ID can also be set at run time.
#. Make sure that the device is already registered with your Azure IoT Hub, or follow the instructions in `Registering the device with Azure IoT Hub`_.
#. Set :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` to the security tag used in :ref:`azure_iot_hub_flash_certs`.
   Optionally, set :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` if more than one server certificate is provisioned.


.. _dps_config:

Configuration using DPS
+++++++++++++++++++++++

To connect to Azure IoT Hub using DPS, complete the following steps:

1. `Set up an Azure IoT Hub Device Provisioning Service (DPS) instance`_ and obtain the ID scope.
#. `Add certificates to the DPS instance`_.
#. Create an *enrollment group* as described in `Device enrollments with Azure Portal`_ and link it to your IoT hub. Select the certificate added in the previous step as the *Primary certificate​​​​​​​*.
#. Enable :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS`.
#. In the `Azure Portal`_, click :guilabel:`Device Provisioning Services` and select the DPS instance to use.
#. In the overview page, locate and copy the ``ID Scope`` and configure :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE` to this string.
   Alternatively, the registration ID can be set at run time.
#. Set the :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_REG_ID` option to the registration ID.
   The registration ID can also be set at run time.
#. Set :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` to the security tag used while :ref:`azure_iot_hub_flash_certs`.
   Optionally, set :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` if more than one server certificate is provisioned.


Application integration
***********************

Initializing the library
========================

The library is initialized by calling the :c:func:`azure_iot_hub_init` function.
The initialization must be successful in order to make the other APIs in the library available to the application.
An event handler is passed as the only argument in to :c:func:`azure_iot_hub_init` which the library will call with associated data to the application about for instance incoming data and other events.
For an exhaustive list of event types and associated data, see :c:enum:`azure_iot_hub_evt_type`.


Using the Device Provisioning Service
=====================================

Azure IoT Hub Device Provisioning Service can be used to provision the device to an IoT Hub.
When the registration process has completed successfully, the device will receive its assigned hostname and device ID to use when connecting to Azure IoT Hub.
The assigned hostname and device ID are stored to non-volatile memory on the device and are available also after reset and loss of power.

The code below shows how to configure and use DPS:

.. code-block:: c

   static void dps_handler(enum azure_iot_hub_dps_reg_status state)
   {
      switch (state) {
      case AZURE_IOT_HUB_DPS_REG_STATUS_NOT_STARTED:
         LOG_INF("AZURE_IOT_HUB_DPS_REG_STATUS_NOT_STARTED");
         break;
      case AZURE_IOT_HUB_DPS_REG_STATUS_ASSIGNING:
         LOG_INF("AZURE_IOT_HUB_DPS_REG_STATUS_ASSIGNING");
         break;
      case AZURE_IOT_HUB_DPS_REG_STATUS_ASSIGNED:
         LOG_INF("AZURE_IOT_HUB_DPS_REG_STATUS_ASSIGNED");

         /* Act on assignment */
         k_sem_give(&dps_assigned_sem);
         break;
      case AZURE_IOT_HUB_DPS_REG_STATUS_FAILED:
         LOG_INF("ZURE_IOT_HUB_DPS_REG_STATUS_FAILED");

         /* Act on registration failure */
         k_sem_give(&dps_registration_failed_sem);
         break;
      default:
         LOG_WRN("Unhandled DPS registration status: %d", state);
         break;
      }
   }

   ...

   int err;
   struct azure_iot_hub_buf assigned_hostname;
   struct azure_iot_hub_buf assigned_device_id;
	struct azure_iot_hub_dps_config dps_cfg = {
		.handler = dps_handler,

      /* Can be left out to use CONFIG_AZURE_IOT_HUB_DPS_REG_ID instead. */
		.reg_id = {
			.ptr = device_id_buf,
			.size = device_id_len,
		},

      /* Can be left out to use CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE instead. */
      .id_scope = {
			.ptr = id_scope_buf,
			.size = id_scope_len,
		},
	};

	err = azure_iot_hub_dps_init(&dps_cfg);
   /* Error handling */

   err = azure_iot_hub_dps_start();
	if (err == 0) {
		LOG_INF("The DPS process has started");

      /* Wait for the registration process to complete. */
      err = k_sem_take(&dps_done_sem, K_SECONDS(SOME_TIMEOUT));
      /* Error handling */
	} else if (err == -EALREADY) {
		LOG_INF("Already assigned to an IoT hub, skipping DPS");
	} else {
      /* Error handling */
	}
	err = azure_iot_hub_dps_hostname_get(assigned_hostname);
   /* Error handling */

	err = azure_iot_hub_dps_device_id_get(assigned_device_id);
   /* Error handling */

   /* Use the hostname and device ID to connect to IoT Hub. */

After successfully registering the device, the application can proceed to connect to the assigned IoT Hub using the obtained device ID.

When a device has been assigned to an IoT Hub and the information is stored to non-volatile memory, the DPS APIs will always return the stored information and not trigger a new registration.
To delete the stored assignment information, call :c:func:`azure_iot_hub_dps_reset` to delete all information, alternatively :c:func:`azure_iot_hub_dps_hostname_delete` or :c:func:`azure_iot_hub_dps_device_id_delete` to delete specific information.
After calling :c:func:`azure_iot_hub_dps_reset`, the library must be initialized again, after which a new registration with the DPS can be started by calling :c:func:`azure_iot_hub_dps_start`.

The DPS APIs are documented in the :ref:`azure_iot_hub_dps_api` section.

Connecting to Azure IoT Hub
===========================

After the initialization, calling :c:func:`azure_iot_hub_connect` will connect the device to the configured IoT hub or DPS instance, depending on the configuration.
The initial TLS handshake takes some time to complete, typically in the range of few seconds, depending on the network conditions and the TLS cipher suite used.
During the TLS handshake, :c:func:`azure_iot_hub_connect` blocks, so care must be taken when deciding the context from which the API is called.
Optionally, DPS registration can be run automatically as part of the call to :c:func:`azure_iot_hub_connect`.
Note that :c:func:`azure_iot_hub_connect` will block when DPS registration is pending.
Running DPS as part of :c:func:`azure_iot_hub_connect` also limits the DPS configuration options in several ways:

* The device ID will be used as registration ID when registering with the DPS server.
* The ID scope will be set to :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE`.

It is recommended to use the DPS APIs directly if more control over the DPS registration process is needed.

When using :c:func:`azure_iot_hub_connect`, you can choose to provide hostname to the IoT Hub and device ID at run time, or let the library use Kconfig options.

Below is an example for setting the hostname and device ID at run time:

.. code-block:: c

   struct azure_iot_hub_config cfg = {
      .hostname = {
         .ptr = hostname_buffer,
         .size = hostname_length,
      },
      .device_id = {
         .ptr = device_id_buffer,
         .size = device_id_length,
      },
      .use_dps = false,
   };

   err = azure_iot_hub_connect(&cfg);
   /* Error handling */

It is allowed to pass ``NULL`` or zeroed out configuration to :c:func:`azure_iot_hub_connect`.
The library will then use the values for hostname and device ID from the Kconfig options :kconfig:option:`CONFIG_AZURE_IOT_HUB_HOSTNAME` and :kconfig:option:`CONFIG_AZURE_IOT_HUB_DEVICE_ID`, respectively.

The below code uses Kconfig value for device ID (and by extension DPS registration ID) and runs DPS to acquire the assigned IoT Hub hostname and assigned device ID.

.. code-block:: c

   struct azure_iot_hub_config cfg = {
      .use_dps = true,
   };

   err = azure_iot_hub_connect(&cfg);
   /* Error handling */

After a successful connection, the library automatically subscribes to the following standard Azure IoT Hub MQTT topics (See `Azure IoT Hub MQTT protocol support`_ for details):

* ``devices/<device ID>/messages/devicebound/#`` (cloud-to-device messages)
* ``$iothub/twin/PATCH/properties/desired/#`` (desired properties update notifications)
* ``$iothub/twin/res/#`` (operation responses)
* ``$iothub/methods/POST/#`` (direct method requests)

Currently, the library does not support persistent MQTT sessions.
Hence subscriptions are requested for each connection to the IoT hub.

You can find more information about the available APIs in the :ref:`azure_iot_hub_api` section.


Configuration
*************

To use the Azure IoT Hub library, you must enable :kconfig:option:`CONFIG_AZURE_IOT_HUB`.

You can configure the following options when using this library:

* :kconfig:option:`CONFIG_AZURE_IOT_HUB_HOSTNAME` - Sets the Azure IoT Hub host name. Note that the hostname can also be provided at run time.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DEVICE_ID` - Configures the device ID. The device ID can also be set at run time.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEND_TIMEOUT` - Enables timeout when sending data to an IoT Hub.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEND_TIMEOUT_SEC` - The send timeout to use when sending data, in seconds.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_USER_NAME_BUF_SIZE` - Set the user name buffer size. This buffer can be tweaked to reduce stack usage if you know roughly the size that your device ID will be.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_SEC_TAG` - Security tag where the Azure IoT Hub certificates are stored.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_SECONDARY_SEC_TAG` - Secondary security tag that can be used for a seconds CA root certificate.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_PORT` - TCP port number to connect to.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_MQTT_RX_TX_BUFFER_LEN` - Size of the MQTT RX and TX buffer that limits how large messages can be, excluding the payload size.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_MQTT_PAYLOAD_BUFFER_LEN` - MQTT payload buffer size.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_STACK_SIZE` - Stack size for the internal thread in the library.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_AUTO_DEVICE_TWIN_REQUEST` - Automatically request the device thiw upon connection to an IoT Hub.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_TOPIC_MAX_LEN` - The maximum topic length. The topic buffers are allocated on the stack, and this option may have to be adjusted with your device ID length.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_MSG_PROPERTY_RECV_MAX_COUNT` - The maximum message properties count that can be parsed from an incoming message's topic.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_MSG_PROPERTY_BUFFER_SIZE` - The size of the internal message property buffer used when sending messages with message properties, allocated on the stack. This size can be adjusted to fit your needs.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_NATIVE_TLS` - Configures the socket to be native for TLS instead of offloading TLS operations to the modem.

Configuration specific to DPS:

* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS` - Enables Azure IoT Hub DPS.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_HOSTNAME` - Hostname of the DPS server.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_REG_ID` - Registration ID to use in the registration request to DPS.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_HOSTNAME_MAX_LEN` - Maximum length of the assigned hostname received from DPS.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_DEVICE_ID_MAX_LEN` - Maximum length of the assigned device ID received from DPS.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_TOPIC_BUFFER_SIZE` - Size of the internal topic buffers in the DPS library.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_USER_NAME_BUFFER_SIZE` - User name buffer size.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE` - Sets the Azure IoT Hub DPS ID scope that is used while provisioning the device.
* :kconfig:option:`CONFIG_AZURE_IOT_HUB_DPS_OPERATION_ID_BUFFER_SIZE` - Size of the operation ID buffer. The operation ID is received from the IoT Hub during registration.

API documentation
*****************

.. _azure_iot_hub_api:

Azure IoT Hub API
=================

| Header file: :file:`include/net/azure_iot_hub.h`
| Source files: :file:`subsys/net/lib/azure_iot_hub/src/azure_iot_hub.c`

.. _azure_iot_hub_dps_api:

Azure IoT Hub DPS API
=====================

| Header file: :file:`include/net/azure_iot_hub_dps.h`
| Source files: :file:`subsys/net/lib/azure_iot_hub/src/azure_iot_hub_dps.c`


.. doxygengroup:: azure_iot_hub
   :project: nrf
   :members:
